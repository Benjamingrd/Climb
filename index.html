<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Climb Pro App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Climb Pro">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #f7f8fa;
  --card-bg: #ffffff;
  --primary: #007bff;
  --primary-dark: #0056b3;
  --secondary: #6c757d;
  --start-color: rgba(40,167,69,0.3);
  --normal-color: rgba(220,53,69,0.3);
  --top-color: rgba(0,123,255,0.3);
}
body {
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 10px;
  color: #333;
}
h1,h2 { margin: 20px 0 10px; }
.card {
  background: var(--card-bg);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
button {
  background: var(--primary);
  color: white;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}
button:hover { background: var(--primary-dark); }
canvas {
  border: 2px solid #000;
  width: 100%;
  max-height: 400px;
  touch-action: none;
  margin-bottom: 10px;
  display: block;
}
.row { display: flex; gap: 10px; margin-bottom: 10px; }
.row button, .row select { flex: 1; }
.climb-item { cursor: pointer; }
.climb-item:hover { background: #e9ecef; }
.header {
  text-align: center;
  font-weight: 600;
  font-size: 24px;
  margin-bottom: 20px;
  color: #007bff;
}
</style>
</head>

<body>
<div class="header">ðŸ§— Climb Pro</div>

<h2>Add Wall</h2>
<div class="card">
  <input id="wallName" placeholder="Wall name">
  <input type="file" id="wallImage" accept="image/*">
  <button onclick="addWall()">Save Wall</button>
</div>

<h2>New / View Climb</h2>
<div class="card">
  <select id="wallSelect" onchange="loadWall()"></select>

  <canvas id="canvas"></canvas>

  <div class="row">
    <select id="holdType">
      <option value="start">Start</option>
      <option value="normal" selected>Normal</option>
      <option value="top">Top</option>
    </select>
    <button onclick="toggleLock()" id="lockBtn">ðŸ”“ Unlock</button>
  </div>

  <label>Hold size</label>
  <input type="range" min="6" max="30" value="14" id="holdSize">

  <input id="grade" placeholder="Grade (ex: 6B, 7A)">
  <button onclick="undoHold()">Undo last hold</button>
  <button onclick="saveClimb()">Save Climb</button>
</div>

<h2>My Climbs</h2>
<div id="climbList"></div>

<script>
let walls = JSON.parse(localStorage.getItem("walls")) || [];
let climbs = JSON.parse(localStorage.getItem("climbs")) || [];
let currentWall = null;
let holds = [];
let img = new Image();
let locked = false;

// transform
let scale = 1;
let offsetX = 0;
let offsetY = 0;
let lastDist = null;
let lastTouch = null;

// displayed canvas size
let displayWidth = 0;
let displayHeight = 0;

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const holdSize = document.getElementById("holdSize");
const holdType = document.getElementById("holdType");
const lockBtn = document.getElementById("lockBtn");

// Map touch to image coordinates
canvas.addEventListener("pointerdown", e => {
  if (!currentWall) return;
  if (locked) { lastTouch = { x: e.clientX, y: e.clientY }; return; }

  const pos = screenToImageCoords(e.clientX, e.clientY);
  holds.push({ x: pos.x, y: pos.y, r: +holdSize.value, type: holdType.value });
  draw();
});

canvas.addEventListener("pointermove", e => {
  if (!locked || !lastTouch) return;
  offsetX += e.clientX - lastTouch.x;
  offsetY += e.clientY - lastTouch.y;
  lastTouch = { x: e.clientX, y: e.clientY };
  draw();
});
canvas.addEventListener("pointerup", () => lastTouch = null);

canvas.addEventListener("touchmove", e => {
  if(e.touches.length===2){
    e.preventDefault();
    const d = distance(e.touches[0], e.touches[1]);
    if(lastDist){
      scale *= d/lastDist;
      scale = Math.max(0.5, Math.min(scale,4));
      draw();
    }
    lastDist = d;
  }
},{passive:false});
canvas.addEventListener("touchend",()=>lastDist=null);

function screenToImageCoords(x,y){
  const rect = canvas.getBoundingClientRect();
  const relX = x - rect.left;
  const relY = y - rect.top;
  const imgX = relX/rect.width * img.width;
  const imgY = relY/rect.height * img.height;
  return {x: imgX, y: imgY};
}

function distance(a,b){ return Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY); }

function toggleLock(){ 
  locked=!locked;
  lockBtn.textContent=locked?'ðŸ”’ Locked':'ðŸ”“ Unlock';
}

function draw(){
  if(!currentWall) return;
  displayWidth = canvas.clientWidth;
  displayHeight = canvas.clientHeight;
  canvas.width = displayWidth;
  canvas.height = displayHeight;

  ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.drawImage(img,0,0,displayWidth,displayHeight);

  holds.forEach((h,i)=>{
    const x = h.x/img.width*displayWidth;
    const y = h.y/img.height*displayHeight;
    const r = h.r;
    ctx.beginPath();
    let color = h.type==='start'? 'var(--start-color)': h.type==='top'? 'var(--top-color)': 'var(--normal-color)';
    ctx.fillStyle=color;
    ctx.strokeStyle=color.replace('0.3','1');
    ctx.lineWidth=2;
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill(); ctx.stroke();

    ctx.fillStyle='black';
    ctx.font=`${r}px Inter`;
    ctx.fillText(i+1,x-r/3,y+r/3);
  });
}

// Walls
function addWall(){
  if(!wallName.value || !wallImage.files[0]) return;
  const reader=new FileReader();
  reader.onload=()=>{
    walls.push({id:Date.now(),name:wallName.value,image:reader.result});
    localStorage.setItem('walls',JSON.stringify(walls));
    updateWallSelect();
  };
  reader.readAsDataURL(wallImage.files[0]);
}

function updateWallSelect(){
  wallSelect.innerHTML='<option value="">Select wall</option>';
  walls.forEach(w=>wallSelect.innerHTML+=`<option value="${w.id}">${w.name}</option>`);
}
updateWallSelect();

function loadWall(){
  currentWall=walls.find(w=>w.id==wallSelect.value);
  holds=[]; scale=1; offsetX=0; offsetY=0;
  img.onload=draw;
  img.src=currentWall.image;
}

function undoHold(){ holds.pop(); draw(); }

function saveClimb(){
  if(!currentWall||!grade.value) return;
  climbs.push({id:Date.now(),wallId:currentWall.id,grade:grade.value,holds,date:new Date().toLocaleDateString()});
  localStorage.setItem('climbs',JSON.stringify(climbs));
  holds=[]; draw(); drawClimbs();
}

function drawClimbs(){
  climbList.innerHTML='';
  climbs.forEach(c=>{
    const wall = walls.find(w=>w.id===c.wallId);
    const div=document.createElement('div');
    div.className='card climb-item';
    div.innerHTML=`<strong>${wall.name}</strong><br>Grade: ${c.grade}<br>${c.date}`;
    div.onclick=()=>{
      currentWall=wall;
      wallSelect.value=wall.id;
      holds=c.holds;
      scale=1; offsetX=0; offsetY=0;
      img.onload=draw; img.src=wall.image;
    };
    climbList.appendChild(div);
  });
}
drawClimbs();
</script>
</body>
</html>